var max_names_per_page=100;var name_index=null;$(document).ready(function(){$(window).hashchange(function(){if(location.hash.length>0){displayNames(decodeURIComponent(location.hash.substring(1)))}else{displayNames(getNextPage("#"))}});requestXML("name","surnames",function(xml){name_index=parseSurnames(xml);$(window).hashchange()});var $search=$("#search");$search.on("focus",function(){$search.select();var old_text=$search.val();var change=function(){if(old_text!=$search.val()){old_text=$search.val();location.hash="#"+old_text}};var timer=setInterval(function(){change()},200);$search.on("blur",function(){clearInterval(timer);change()})})});function displayNames(page){if(page==null)page="#";page=removeDiacritics(page).toUpperCase();$name_list=$("#name-index").empty();$name_list.append(indexNavbar(page));var subNav=subNavbar(page);if(page.length==1){var $links=subNav.find("a");if($links.length>=1){page=$($links[0]).attr("href").slice(1).toUpperCase()}else{$name_list.append(subNav);for(var i=0;i<name_index[page].length;i+=1){$name_list.append(surnameLink(name_index[page][i]))}}}if(page.length>1){var bucket=page[0];$name_list.append(subNav);var start=page;var end=null;var given=null;if(!name_index.hasOwnProperty(bucket))bucket="#";if(page.indexOf(",")>0){var names=page.split(",");start=names[0];end=names[0];given=$.trim(names[1])}else if(page.indexOf("|")>0){var range=page.split("|");start=range[0];end=range[1]}for(var i=0;i<name_index[bucket].length;i+=1){if(end==null){if(removeDiacritics(name_index[bucket][i].surname).toUpperCase().indexOf(start)==0){$name_list.append(surnameLink(name_index[bucket][i]))}}else{var name=removeDiacritics(name_index[bucket][i].surname).toUpperCase();if(name>=start&&name<=end){if(typeof given=="string"){$name_list.append(surnameLink(name_index[bucket][i],{expanded:true,filter:given,limit:200}))}else{$name_list.append(surnameLink(name_index[bucket][i]))}}}}}}function surnameLink(surname,options){options=options||{};var $div=$("<div class='surname-block'/>");var $link=$("<a/>",{href:"#",text:surname.surname==""?"[blank]":surname.surname});$div.append($link," (",surname.count,")");$link.on("click",function(){requestXML("name",surname.id,function(xml){var names=parseNames(xml);if(options.filter){var filter=options.filter.toUpperCase();var filtered_names=[];for(var index=0;index<names.length;index+=1){if(names[index].given.toUpperCase().indexOf(filter)>=0){filtered_names.push(names[index])}}names=filtered_names}if(options.limit){names=names.slice(0,options.limit)}var $pages=paginateGivenNames(names);$link.off("click");$link.on("click",function(){$pages.toggle();return false});$div.append($pages)});return false});if(options.expanded)$link.click();return $div}var parseNames=function(){var memo={};return function(xml){var firstname=xml.find("names > name:first").find("name").text();if(memo[firstname]){return memo[firstname]}var name_list=[];xml.find("names > name").each(function(index,name){var surname="";var given_name="";name=$(name);var n=name.find("name").text().split(", ");if(n.length==1){surname=n[0];given_name="<blank>";var datePoint=n[0].lastIndexOf(" (");if(datePoint>-1){surname=n[0].slice(0,datePoint);given_name+=n[0].slice(datePoint)}}else{surname=n[0];given_name=n.length>1?n[1]:""}name_list.push({id:name.attr("id"),color:name.attr("color"),surname:surname,given:given_name})});memo[firstname]=name_list;return memo[firstname]}}();function parseSurnames(xml){var keystring="#ABCDEFGHIJKLMNOPQRSTUVWXYZ";var name_list={};for(var i=0;i<keystring.length;i++){name_list[keystring[i]]=[]}xml.find("surnames > surname").each(function(index,surname){surname=$(surname);var name=surname.find("name").text();var name_with_diacritics_stripped=removeDiacritics(name);var count=surname.attr("count");var name_key;if(name.length==0){name_key="#"}else if(name_list.hasOwnProperty(name_with_diacritics_stripped[0].toUpperCase())){name_key=name_with_diacritics_stripped[0].toUpperCase()}else{name_key="#"}name_list[name_key].push({surname:name,id:surname.attr("id"),count:count})});return name_list}var getPreviousPage=function(page){var pages="#ABCDEFGHIJKLMNOPQRSTUVWXYZ";if(!name_index.hasOwnProperty(page))return null;for(var i=pages.indexOf(page)-1;i>=0;i--){if(name_index[pages[i]].length>0)return pages[i]}return null};var getNextPage=function(page){var pages="#ABCDEFGHIJKLMNOPQRSTUVWXYZ";if(!name_index.hasOwnProperty(page))return null;for(var i=pages.indexOf(page)+1;i<pages.length;i++){if(name_index[pages[i]].length>0)return pages[i]}return null};function indexNavbar(page){var pages="#ABCDEFGHIJKLMNOPQRSTUVWXYZ";if(page.length>1)page=page[0];$nav=$("<div class='index-nav-bar' />");var prev_page=getPreviousPage(page);if(prev_page){$("<a/>",{href:"#"+prev_page,text:"< "}).appendTo($nav)}else{$nav.append("< ")}var last_page="#";for(var i=0;i<pages.length;i++){if(pages[i]==page){$nav.append(pages[i]+" ");last_page=pages[i]}else if(name_index[pages[i]].length==0){}else{$("<a/>",{href:"#"+pages[i],text:pages[i]+" "}).appendTo($nav);last_page=pages[i]}}var nextPage=getNextPage(page);if(nextPage){$("<a/>",{href:"#"+nextPage,text:">"}).appendTo($nav)}else{$nav.append(">")}return $nav}function subNavbar(text,cmp){cmp=cmp||"surname";var bucket=name_index[text[0]];sub_buckets=Math.floor(bucket.length/max_names_per_page)+1;if(sub_buckets==1)return $("<span/>");var $ul=$("<ul class='sub-navbar' />");for(var i=0;i<sub_buckets;i++){var bucket_range=[Math.floor(bucket.length*i/sub_buckets),Math.floor(bucket.length*(i+1)/sub_buckets)-1];var range_text=[bucket[bucket_range[0]][cmp],bucket[bucket_range[1]][cmp]];var href=range_text[0]+"|"+range_text[1];var $a=$("<a/>",{text:range_text[0]+"-"+range_text[1],href:"#"+href});if(text==href.toUpperCase())$a.addClass("selected");$("<li/>").append($a).appendTo($ul)}if(text.length==1)$ul.find("a:first").addClass("selected");return $ul}function paginateGivenNames(names){var $div=$("<div/>");var $link_bar=$("<ul/>",{"class":"given-name-link-bar"}).appendTo($div);var $ul=$("<ul/>",{"class":"given-name-list"}).appendTo($div);var ul_total=0;var pages=1;var start_name="";var end_name="";var use_names=true;if(names.length/max_names_per_page>5){use_names=false}if(use_names)$link_bar.addClass("names");$.each(names,function(index,name){if(ul_total==0)start_name=name.given;end_name=name.given;var $li=$("<li/>").append(name.given).appendTo($ul);$li.empty().append(nameLink(name.id,{lazy_load:true,text:name.given,color:name.color}));ul_total+=1;if(ul_total>max_names_per_page){ul_total=0;var $link=function($ul){var text=stripDate(start_name)+"-"+stripDate(end_name);var $a=$("<a/>",{text:use_names?text:pages.toString(),title:use_names?"":text,href:"#"}).on("click",function(){$div.find(".given-name-list").hide();$ul.show();$link_bar.find("a").removeClass("selected");$(this).addClass("selected");return false});return $a}($ul);$("<li/>").append($link).appendTo($link_bar);$ul=$("<ul/>",{"class":"given-name-list"}).hide().appendTo($div);pages+=1}});if(pages>1){var text=stripDate(start_name)+"-"+stripDate(end_name);var $a=$("<a/>",{text:use_names?text:pages.toString(),title:use_names?"":text,href:"#"}).on("click",function(){$div.find(".given-name-list").hide();$ul.show();return false});$("<li/>").append($a).appendTo($link_bar)}$link_bar.find("a:first").addClass("selected");return $div}function stripDate(name){var index=name.lastIndexOf(" (");if(index>-1){name=name.slice(0,index)}return name}