var requestXML=function(){memo={};pending={};var rxml=function(type,id,callback,failure_callback){id=id.toString();if(typeof memo[type]=="undefined")memo[type]={};if(id in memo[type]){callback(memo[type][id])}else{if(typeof pending[type]=="undefined")pending[type]={};if(id in pending[type]){pending[type][id].push(callback)}else{pending[type][id]=[callback];var version=$.cookie("upload-id")||Math.floor(Math.random()*1e5);var url="data/"+type+"/"+id+".xml?v="+version;if(type=="root")url="data/"+id+".xml?v="+version;$.ajax({url:url,dataType:$.browser.msie?"text":"xml",success:function(data,textStatus,jqXHR){var xml;if(typeof data=="string"){xml=new ActiveXObject("Microsoft.XMLDOM");xml.async=false;xml.loadXML(data)}else{xml=data}memo[type][id]=$(xml);$.each(pending[type][id],function(index,cb){cb(memo[type][id])})},error:function(jqXHR,textStatus,errorThrown){if(failure_callback)failure_callback()}})}}};return rxml}();var parseSources=function(sources_xml){var sources=[];sources_xml.find("source").each(function(index,source){source=$(source);sources.push({footnote:source.find("footnote").text(),media:parseMedia(source.find("media")),webtags:parseWebtags(source.find("webtags"))})});return sources};var parseMedia=function(media_xml){var media=[];media_xml.find("mediaitem").each(function(index,m){m=$(m);media.push({filename:escape(m.find("filename").text().toLowerCase().replace(/\s/g,"_")),comment:m.find("comment").text(),id:m.attr("id"),getCaption:function(callback){requestXML("media",m.attr("id"),function(xml){callback(xml.find("caption").text())})}})});return media};var parseWebtags=function(webtags_xml){var webtags=[];webtags_xml.find("webtag").each(function(index,w){w=$(w);webtags.push({name:w.find("name").text(),url:w.find("url").text(),note:w.find("note").text()})});return webtags};