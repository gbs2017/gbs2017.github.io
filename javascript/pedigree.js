var tree_depth=4;var primary=null;var root=null;$(document).ready(function(){$(window).hashchange(function(){clearPedigreeChart();getPrimaryId(function(){primary=new Person(primary_id);primary.ready(function(self){createPedigreeChart(self)})})});show_root_button();$(window).hashchange()});function getPrimaryId(callback){if(location.hash.length>0){primary_id=parseInt(location.hash.substring(1));$.cookie("last_primary",primary_id);callback()}else if($.cookie("last_primary")!==null){primary_id=$.cookie("last_primary");root=$.cookie("root_person");show_root_button();callback()}else{requestXML("root","settings",function(xml){primary_id=parseInt(xml.find("root").text());$.cookie("last_primary",primary_id);callback()})}}function show_root_button(){function show_button(){$("#root-button").css("display","block").attr("href","#"+root)}if(root==null){if($.cookie("root_person")!==null){root=$.cookie("root_person");show_button()}else{requestXML("root","settings",function(xml){root=parseInt(xml.find("root").text());$.cookie("root_person",root);show_button()})}}else{show_button()}}function clearPedigreeChart(){$("body").off("click");$("#pedigree-chart").children().detach().parent().append("<div id='person-popup'/>")}var createPedigreeBox=function(){var memo={};return function(person,options){options=$.extend({row:0,column:0},options);if(memo[person.id]){var classString="pedigree-box ";if(!person.image){classString+="no-image "}classString+="row"+options.row+" column"+options["column"];var box=memo[person.id].clone().attr("class",classString);return box}var $box=$("<div/>",{"class":"pedigree-box no-image"});$box.addClass("row"+options["row"].toString());$box.addClass("column"+options["column"].toString());var lightclass=person.box_color>0?" light":"";var $individual_link=$("<a/>",{"class":"pedigree-box-individual-link"+lightclass,title:"Individual Page",href:personUrl(person,"individual")});var $families_link=$("<span/>",{"class":"pedigree-box-families-dropdown-link"+lightclass,title:"Show Families"});var $families_dropdown=familyDropdown(person).hide();$families_link.on("click",function(){$families_dropdown.fadeIn(100);$("body").on("click",function hideDrop(e){if($(e.target).closest($families_link).length==0){$("body").off("click",hideDrop);$families_dropdown.fadeOut(100)}})});var $root_link=$("<a/>",{"class":"pedigree-box-root-link"+lightclass,title:"Pedigree Chart",href:"#"+person.id});$("<div class='corner-buttons'/>").append($individual_link,$families_link,$root_link).appendTo($box);$box.append($families_dropdown);var text_max=25;if(person.image){text_max=20;var $image=$("<img/>",{"class":"thumbnail",src:imageUrl(person.image,"tiny")});var $image_link=$("<a/>",{href:imageUrl(person.image,"normal")}).append($image).colorbox({transition:"none",opacity:"0.2"});var $thumbnail_box=$("<div class='thumbnail-box'/>").append($image_link).appendTo($box)}var $name_bar;if(person.name.length<text_max){$name_bar=$("<span/>",{"class":"name",text:person.name}).appendTo($box)}else{$name_bar=$("<span/>",{"class":"name",text:person.name.slice(0,text_max-3)+"...",title:person.name}).appendTo($box)}if(person.box_color){$box.find(".name").addClass("color"+person.box_color)}var $info=$("<div/>",{"class":"info"});if(person.image){$image.on("load",function(){var width=this.width;$thumbnail_box.show();if(width==0)width=$image.width();$thumbnail_box.css("width",width+"px");$box.removeClass("no-image");$name_bar.css("margin-left",width+"px");$info.css("margin-left",width+"px")})}if(person.hasBirth()&&person.birth.date){$("<span/>",{"class":"lifespan",text:person.birth["date"]+" - "+(person.hasDeath()&&person.death.date?person.death.date:"")}).appendTo($info)}$info.appendTo($box);memo[person.id]=$box;return $box}}();function createConnector(direction,row,column){return $("<div/>",{"class":"connector "+direction+" row"+row.toString()+" column"+column.toString()})}function createNavigationArrow(direction,row){if(direction=="right"){var new_primary_id=row<1<<tree_depth-2?primary.father.id:primary.mother.id;return $("<a/>",{"class":"arrow right-arrow",text:">",href:"#"+new_primary_id.toString()}).addClass("row"+row.toString()+" column"+(tree_depth-1).toString())}else{var $a=$("<a/>",{"class":"arrow left-arrow row0 column0",text:"<",href:"#"+primary.current_child.id.toString()});var $span=$("<span/>").append($a);if(primary.children.length>1){$span.append(createChildList(primary))}return $span}}function createChildList(person){var $span=$("<span class='child-selector arrow row0 column0' title='Select Child'>+</span>");var $ul=$("<ul class='family-dropdown'/>").hide();for(var index=0;index<person.children.length;index+=1){var child=person.children[index];var $li=$("<a/>",{href:personUrl(child,"pedigree")}).append(nameText(child)).wrap("<li/>").parent();if(child.id==person.current_child.id){$ul.prepend($li)}else{$ul.append($li)}}$span.append($ul);$span.on("click",function(){$ul.fadeIn(100);$("body").on("click",function hideDrop(e){if($(e.target).closest($span).length==0){$("body").off("click",hideDrop);$ul.fadeOut(100)}})});return $span}function createPedigreeChart(person,row,column){column=column||0;row=row||0;if(column>=tree_depth)return;createPedigreeBox(person,{row:row,column:column}).appendTo("#pedigree-chart");if(column==tree_depth-1){if(person.current_parents){createNavigationArrow("right",row).appendTo("#pedigree-chart")}}else if(column==0){if(primary.hasChildren()){createNavigationArrow("left").appendTo("#pedigree-chart")}}if(person.current_parents){if(person.current_parents.father){if(column<tree_depth-1)createConnector("up",row,column).appendTo("#pedigree-chart");person.current_parents.father.fetch().ready(function(father){createPedigreeChart(father,row*2,column+1)})}if(person.current_parents.mother){if(column<tree_depth-1)createConnector("down",row,column).appendTo("#pedigree-chart");person.current_parents.mother.fetch().ready(function(mother){createPedigreeChart(mother,row*2+1,column+1)})}}}function displayPerson(person,box){box.addClass("popup");$("body").on("click",function hideDisplay(e){if($(e.target).closest(box).length==0){$("body").off("click",hideDisplay);$(".pedigree-box").removeClass("popup").find(".group-dropdown").hide()}})}